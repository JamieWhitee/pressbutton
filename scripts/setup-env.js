/**
 * ğŸš€ PressButton é¡¹ç›®ç¯å¢ƒè‡ªåŠ¨é…ç½®è„šæœ¬
 *
 * åŠŸèƒ½ï¼š
 * - æ£€æŸ¥å¹¶åˆ›å»ºå¿…è¦çš„ç¯å¢ƒæ–‡ä»¶
 * - ä¸ºæ–°åŒäº‹æä¾›ä¸€é”®ç¯å¢ƒæ­å»º
 * - æ”¯æŒæœ¬åœ°å¼€å‘å’ŒDockerç¯å¢ƒ
 *
 * ä½¿ç”¨æ–¹æ³•ï¼š
 * npm run setup
 */

const fs = require('fs');
const path = require('path');

// é¢œè‰²è¾“å‡ºå·¥å…·
const colors = {
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  blue: '\x1b[34m',
  reset: '\x1b[0m'
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

/**
 * åˆ›å»ºå‰ç«¯ç¯å¢ƒé…ç½®
 */
function setupWebEnvironment() {
  const webEnvPath = path.join(__dirname, '../pressbutton-web/.env.local');

  if (!fs.existsSync(webEnvPath)) {
    const webEnvContent = `# PressButton Web - Local Development Environment
# Auto-generated by setup script on ${new Date().toISOString()}

# API Configuration - æ³¨æ„ï¼šå¿…é¡»åŒ…å« /api åç¼€
NEXT_PUBLIC_API_URL=http://localhost:3001/api

# Development Environment
NODE_ENV=development

# ğŸ”§ å¼€å‘æç¤ºï¼š
# - æœ¬åœ°å¼€å‘ä½¿ç”¨ localhost:3001
# - Docker ç¯å¢ƒä¼šè‡ªåŠ¨ä½¿ç”¨ docker-backend:3001
# - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ productionTodo
`;

    fs.writeFileSync(webEnvPath, webEnvContent);
    log('âœ… Created pressbutton-web/.env.local', 'green');
    return true;
  } else {
    log('â„¹ï¸  pressbutton-web/.env.local already exists', 'yellow');
    return false;
  }
}

/**
 * åˆ›å»ºåç«¯ç¯å¢ƒé…ç½®
 */
function setupApiEnvironment() {
  const apiEnvPath = path.join(__dirname, '../pressbutton-api/.env');

  if (!fs.existsSync(apiEnvPath)) {
    const apiEnvContent = `# PressButton API - Local Development Environment
# Auto-generated by setup script on ${new Date().toISOString()}

# PostgreSQL Database Configuration
DATABASE_URL=postgresql://postgres:admin123@localhost:5432/pressbutton_dev

# JWT Authentication Configuration
JWT_SECRET=dev-secret-key-${Date.now()}-change-in-production
JWT_EXPIRES_IN=7d

# Server Configuration
PORT=3001
NODE_ENV=development

# CORS Configuration - å…è®¸å‰ç«¯è®¿é—®
CORS_ORIGIN=http://localhost:3000

# Rate Limiting Configuration
THROTTLE_TTL=60000
THROTTLE_LIMIT=100

# ğŸ”§ å¼€å‘æç¤ºï¼š
# - è¯·ç¡®ä¿ PostgreSQL å·²å¯åŠ¨å¹¶åˆ›å»ºäº† pressbutton_dev æ•°æ®åº“
# - JWT_SECRET åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¯·ä½¿ç”¨å¼ºéšæœºå¯†é’¥
# - æ•°æ®åº“å¯†ç è¯·æ ¹æ®ä½ çš„æœ¬åœ°é…ç½®ä¿®æ”¹
`;

    fs.writeFileSync(apiEnvPath, apiEnvContent);
    log('âœ… Created pressbutton-api/.env', 'green');
    return true;
  } else {
    log('â„¹ï¸  pressbutton-api/.env already exists', 'yellow');
    return false;
  }
}

/**
 * åˆ›å»º Docker ç¯å¢ƒé…ç½®
 */
function setupDockerEnvironment() {
  const dockerEnvPath = path.join(__dirname, '../.env.docker');

  const dockerEnvContent = `# PressButton Docker Environment Configuration
# Auto-generated by setup script on ${new Date().toISOString()}

# ===========================================
# Docker Services Configuration
# ===========================================

# Frontend Docker Environment
NEXT_PUBLIC_API_URL=http://docker-backend:3001/api

# Backend Docker Environment
DATABASE_URL=postgresql://postgres:admin123@postgres:5432/pressbutton_dev
JWT_SECRET=docker-secret-key-change-in-production
PORT=3001
NODE_ENV=development
CORS_ORIGIN=http://localhost:3000

# Database Configuration
POSTGRES_DB=pressbutton_dev
POSTGRES_USER=postgres
POSTGRES_PASSWORD=admin123

# ğŸ³ Docker æç¤ºï¼š
# - å®¹å™¨å†…æœåŠ¡é€šè¿‡æœåŠ¡åé€šä¿¡ (docker-backend, postgres)
# - å¤–éƒ¨è®¿é—®ä»ä½¿ç”¨ localhost ç«¯å£æ˜ å°„
`;

  fs.writeFileSync(dockerEnvPath, dockerEnvContent);
  log('âœ… Created .env.docker for Docker environment', 'green');
}

/**
 * æ£€æŸ¥å¿…è¦çš„ç›®å½•å’Œæ–‡ä»¶
 */
function checkProjectStructure() {
  const requiredDirs = [
    'pressbutton-web',
    'pressbutton-api'
  ];

  const missingDirs = requiredDirs.filter(dir =>
    !fs.existsSync(path.join(__dirname, '..', dir))
  );

  if (missingDirs.length > 0) {
    log('âŒ Missing required directories:', 'red');
    missingDirs.forEach(dir => log(`   - ${dir}`, 'red'));
    return false;
  }

  return true;
}

/**
 * ä¸»è¦è®¾ç½®å‡½æ•°
 */
function setupEnvironment() {
  log('\nğŸš€ Starting PressButton Environment Setup...', 'blue');
  log('=' .repeat(50), 'blue');

  // æ£€æŸ¥é¡¹ç›®ç»“æ„
  if (!checkProjectStructure()) {
    log('\nâŒ Setup failed: Project structure incomplete', 'red');
    process.exit(1);
  }

  let changesCount = 0;

  // è®¾ç½®å‰ç«¯ç¯å¢ƒ
  if (setupWebEnvironment()) changesCount++;

  // è®¾ç½®åç«¯ç¯å¢ƒ
  if (setupApiEnvironment()) changesCount++;

  // è®¾ç½®Dockerç¯å¢ƒ
  setupDockerEnvironment();
  changesCount++;

  // å®Œæˆæç¤º
  log('\n' + '=' .repeat(50), 'blue');
  log('ğŸ‰ Environment Setup Complete!', 'green');
  log(`ğŸ“ ${changesCount} configuration files created/updated`, 'green');

  log('\nğŸ“‹ Next Steps:', 'blue');
  log('1. æ£€æŸ¥å¹¶ä¿®æ”¹æ•°æ®åº“è¿æ¥é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰', 'yellow');
  log('2. ç¡®ä¿ PostgreSQL æœåŠ¡å·²å¯åŠ¨', 'yellow');
  log('3. è¿è¡Œ npm run dev å¯åŠ¨å¼€å‘ç¯å¢ƒ', 'yellow');
  log('4. æˆ–è¿è¡Œ npm run docker:dev å¯åŠ¨ Docker ç¯å¢ƒ', 'yellow');

  log('\nğŸ”— Useful Commands:', 'blue');
  log('- npm run dev          # å¯åŠ¨æœ¬åœ°å¼€å‘', 'yellow');
  log('- npm run docker:dev   # å¯åŠ¨ Docker å¼€å‘', 'yellow');
  log('- npm run setup        # é‡æ–°è¿è¡Œæ­¤è„šæœ¬', 'yellow');
}

// è¿è¡Œè®¾ç½®
try {
  setupEnvironment();
} catch (error) {
  log(`\nâŒ Setup failed: ${error.message}`, 'red');
  process.exit(1);
}
